      {/* Report Modal */}
      <IncidentDetailsModal
        showModal={showReportModal}
        onClose={closeReportModal}
        selectedIncidentDetails={selectedIncidentDetails}
        loadingReport={loadingReport}
        bspAnalysisData={bspAnalysisData}
        loadingBspAnalysis={loadingBspAnalysis}
        activeModalTab={activeModalTab}
        setActiveModalTab={setActiveModalTab}
        collapsedSections={collapsedSections}
        toggleSection={toggleSection}
        handleRunBspAnalysis={handleRunBspAnalysis}
        exportIncidentPdf={exportIncidentPdf}
        onDelete={(id) => {
          setSelectedId(id);
          setIsModalOpen(true);
        }}
        formatDateTime={formatDateTime}
        getStatusBadgeClass={getStatusBadgeClass}
        getSeverityBadgeClass={getSeverityBadgeClass}
      />
          <div
            style={{
              backgroundColor: 'white',
              borderRadius: '8px',
              maxWidth: '1200px',
              width: '100%',
              maxHeight: '90vh',
              display: 'flex',
              flexDirection: 'column',
              boxShadow: '0 10px 40px rgba(0,0,0,0.3)'
            }}
            onClick={(e) => e.stopPropagation()}
          >
            <div className="modal-content" style={{ display: 'flex', flexDirection: 'column', height: '100%' }}>
              {/* Modal Header */}
              <div className="modal-header" style={{ padding: '20px 24px', borderBottom: '1px solid #e5e7eb', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <h3 className="modal-title" style={{ fontSize: '1.5rem', fontWeight: 'bold', margin: 0 }}>
                    Incident Details
                  </h3>
                  <span className="badge badge-success" style={{ fontSize: '0.75rem', padding: '4px 8px' }}>
                    <i className="ki-outline ki-check-circle text-xs mr-1"></i>
                    NDIS
                  </span>
                </div>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                  <button
                    type="button"
                    className="btn btn-sm btn-light"
                    onClick={() => selectedIncidentDetails && exportIncidentPdf(selectedIncidentDetails.id)}
                    disabled={!selectedIncidentDetails}
                    style={{ cursor: 'pointer' }}
                  >
                    <i className="ki-outline ki-file-down text-base mr-1"></i>
                    Export
                  </button>
                  <button
                    type="button"
                    className="btn btn-sm btn-primary"
                    onClick={() => {
                      if (selectedIncidentDetails) {
                        navigate(`/incidents/${selectedIncidentDetails.id}/edit`);
                      }
                    }}
                    disabled={!selectedIncidentDetails}
                    style={{ cursor: 'pointer' }}
                  >
                    <i className="ki-outline ki-notepad-edit text-base mr-1"></i>
                    Edit
                  </button>
                  <button
                    type="button"
                    className="btn btn-sm btn-icon btn-light"
                    onClick={() => {
                      if (selectedIncidentDetails) {
                        setSelectedId(selectedIncidentDetails.id);
                        setShowReportModal(false);
                        setIsModalOpen(true);
                      }
                    }}
                    style={{ cursor: 'pointer' }}
                  >
                    <i className="ki-outline ki-trash text-base"></i>
                  </button>
                  <button
                    type="button"
                    className="btn btn-sm btn-icon btn-light"
                    onClick={closeReportModal}
                    style={{ cursor: 'pointer' }}
                  >
                    <i className="ki-outline ki-cross text-base"></i>
                  </button>
                </div>
              </div>

              {/* Tab Navigation - Only show when not loading */}
              {!loadingReport && selectedIncidentDetails && (
                <div style={{ borderBottom: '1px solid #e5e7eb', padding: '0 24px', backgroundColor: '#f9fafb' }}>
                  <div style={{ display: 'flex', gap: '32px' }}>
                    <button
                      onClick={() => setActiveModalTab('details')}
                      style={{
                        padding: '16px 4px',
                        border: 'none',
                        background: 'transparent',
                        fontSize: '0.875rem',
                        fontWeight: activeModalTab === 'details' ? '600' : '500',
                        color: activeModalTab === 'details' ? '#6b46c1' : '#6b7280',
                        borderBottom: activeModalTab === 'details' ? '2px solid #6b46c1' : '2px solid transparent',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        position: 'relative',
                        top: '1px'
                      }}
                    >
                      Incident Details
                    </button>
                    <button
                      onClick={() => setActiveModalTab('bsp')}
                      style={{
                        padding: '16px 4px',
                        border: 'none',
                        background: 'transparent',
                        fontSize: '0.875rem',
                        fontWeight: activeModalTab === 'bsp' ? '600' : '500',
                        color: activeModalTab === 'bsp' ? '#6b46c1' : '#6b7280',
                        borderBottom: activeModalTab === 'bsp' ? '2px solid #6b46c1' : '2px solid transparent',
                        cursor: 'pointer',
                        transition: 'all 0.2s ease',
                        position: 'relative',
                        top: '1px'
                      }}
                    >
                      BSP Analysis
                    </button>
                  </div>
                </div>
              )}

              {/* Modal Body */}
              <div className="modal-body" style={{ flex: 1, overflowY: 'auto', padding: '0' }}>
                {loadingReport ? (
                  <div style={{
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    minHeight: '400px',
                    padding: '40px 20px'
                  }}>
                    <div style={{
                      position: 'relative',
                      width: '120px',
                      height: '120px',
                      marginBottom: '32px'
                    }}>
                      {/* Outer rotating ring */}
                      <div style={{
                        position: 'absolute',
                        width: '100%',
                        height: '100%',
                        border: '4px solid #e5e7eb',
                        borderTop: '4px solid #6b46c1',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite'
                      }}></div>
                      {/* Middle rotating ring */}
                      <div style={{
                        position: 'absolute',
                        width: '80%',
                        height: '80%',
                        top: '10%',
                        left: '10%',
                        border: '4px solid #e5e7eb',
                        borderBottom: '4px solid #6b46c1',
                        borderRadius: '50%',
                        animation: 'spin 1.5s linear infinite reverse'
                      }}></div>
                      {/* Center icon */}
                      <div style={{
                        position: 'absolute',
                        width: '100%',
                        height: '100%',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <i className="ki-outline ki-document text-4xl text-primary" style={{
                          animation: 'pulse 2s ease-in-out infinite'
                        }}></i>
                      </div>
                    </div>

                    <div style={{ textAlign: 'center' }}>
                      <h4 style={{
                        fontSize: '1.25rem',
                        fontWeight: '600',
                        color: '#111827',
                        marginBottom: '8px'
                      }}>
                        Loading Incident Report
                      </h4>
                      <p style={{
                        fontSize: '0.875rem',
                        color: '#6b7280',
                        marginBottom: '16px'
                      }}>
                        Fetching incident details and AI-generated reports...
                      </p>

                      {/* Progress dots */}
                      <div style={{
                        display: 'flex',
                        gap: '8px',
                        justifyContent: 'center',
                        alignItems: 'center'
                      }}>
                        <div style={{
                          width: '8px',
                          height: '8px',
                          borderRadius: '50%',
                          backgroundColor: '#6b46c1',
                          animation: 'bounce 1.4s ease-in-out infinite'
                        }}></div>
                        <div style={{
                          width: '8px',
                          height: '8px',
                          borderRadius: '50%',
                          backgroundColor: '#6b46c1',
                          animation: 'bounce 1.4s ease-in-out 0.2s infinite'
                        }}></div>
                        <div style={{
                          width: '8px',
                          height: '8px',
                          borderRadius: '50%',
                          backgroundColor: '#6b46c1',
                          animation: 'bounce 1.4s ease-in-out 0.4s infinite'
                        }}></div>
                      </div>
                    </div>
                  </div>
                ) : selectedIncidentDetails ? (
                  <div>
                    {/* BSP ANALYSIS TAB */}
                    {activeModalTab === 'bsp' && (
                      <div style={{
                        animation: 'fadeIn 0.3s ease-in-out',
                        padding: '24px',
                        minHeight: '400px'
                      }}>
                        {/* BSP ANALYSIS SECTION */}
                        {loadingBspAnalysis ? (
                      <div style={{
                        backgroundColor: '#f5f3ff',
                        borderLeft: '4px solid #6b46c1',
                        borderRadius: '8px',
                        padding: '24px',
                        marginBottom: '24px'
                      }}>
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'flex-start',
                          marginBottom: '24px'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <i className="ki-outline ki-abstract-26" style={{ fontSize: '24px', color: '#6b46c1' }}></i>
                            <h4 style={{ fontSize: '1.125rem', fontWeight: '600', color: '#1f2937', margin: 0 }}>
                              AI-Powered BSP Analysis
                            </h4>
                          </div>
                          <button
                            type="button"
                            className="btn btn-sm btn-primary"
                            disabled
                            style={{ cursor: 'not-allowed' }}
                          >
                            <i className="ki-outline ki-abstract-26 text-sm mr-1"></i>
                            Analyzing...
                          </button>
                        </div>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          padding: '40px 20px'
                        }}>
                          <div style={{
                            position: 'relative',
                            width: '80px',
                            height: '80px',
                            marginBottom: '24px'
                          }}>
                            <div style={{
                              position: 'absolute',
                              width: '100%',
                              height: '100%',
                              border: '4px solid #e9d5ff',
                              borderTop: '4px solid #6b46c1',
                              borderRadius: '50%',
                              animation: 'spin 1s linear infinite'
                            }}></div>
                            <div style={{
                              position: 'absolute',
                              width: '100%',
                              height: '100%',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}>
                              <i className="ki-outline ki-abstract-26" style={{ fontSize: '32px', color: '#6b46c1' }}></i>
                            </div>
                          </div>
                          <p style={{ fontSize: '1rem', color: '#6b46c1', marginBottom: '8px', textAlign: 'center' }}>
                            Analyzing incident against Behavior Support Plan...
                          </p>
                          <p style={{ fontSize: '0.875rem', color: '#9333ea', textAlign: 'center' }}>
                            Maps triggers, strategies, and risk factors against the participant's BSP
                          </p>
                        </div>
                      </div>
                    ) : bspAnalysisData?.bsp_analysis ? (
                      <div style={{
                        backgroundColor: 'white',
                        borderLeft: '4px solid #6b46c1',
                        borderRadius: '8px',
                        padding: '20px',
                        minHeight: '300px'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '20px', justifyContent: 'space-between' }}>
                          <h4 style={{ fontSize: '1.125rem', fontWeight: '600', color: '#6b46c1', margin: 0 }}>
                            BSP Analysis & Recommendations
                          </h4>
                          <p style={{ fontSize: '0.75rem', color: '#9333ea', margin: 0 }}>
                            Click on any section below to expand
                          </p>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', minHeight: '100px' }}>
                        {/* BSP Gaps Detected */}
                        {bspAnalysisData.bsp_analysis?.gaps_detected?.count > 0 && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspGapsDetected')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-information-2" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  BSP Gaps Detected
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge badge-danger" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600' }}>
                                  {bspAnalysisData.bsp_analysis.gaps_detected.count} Critical
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspGapsDetected ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspGapsDetected && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {(bspAnalysisData.bsp_analysis.gaps_detected.data || []).map((gap: any, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #ef4444', border: '1px solid #fee2e2', display: 'flex', alignItems: 'start', gap: '10px' }}>
                                      <i className="ki-outline ki-cross-circle" style={{ fontSize: '16px', color: '#ef4444', marginTop: '2px', flexShrink: 0 }}></i>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5', margin: 0 }}>{gap.description || gap}</p>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}



                        {/* Draft BSP Update */}
                        {bspAnalysisData.bsp_analysis.draft_update?.data && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspDraftUpdate')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-document" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  Draft BSP Update
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge badge-primary" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600' }}>
                                  Draft
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspDraftUpdate ? 'ki-down' : 'ki-up'}`}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspDraftUpdate && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  {bspAnalysisData.bsp_analysis.draft_update.data.context_of_behaviour && (
                                    <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>CONTEXT OF BEHAVIOUR</p>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{bspAnalysisData.bsp_analysis.draft_update.data.context_of_behaviour}</p>
                                    </div>
                                  )}
                                  {bspAnalysisData.bsp_analysis.draft_update.data.environmental_considerations && (
                                    <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>ENVIRONMENTAL CONSIDERATIONS</p>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{bspAnalysisData.bsp_analysis.draft_update.data.environmental_considerations}</p>
                                    </div>
                                  )}
                                  {bspAnalysisData.bsp_analysis.draft_update.data.trauma_informed_adjustments && (
                                    <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>TRAUMA-INFORMED ADJUSTMENTS</p>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{bspAnalysisData.bsp_analysis.draft_update.data.trauma_informed_adjustments}</p>
                                    </div>
                                  )}
                                  {bspAnalysisData.bsp_analysis.draft_update.data.safety_recommendations && (
                                    <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>SAFETY RECOMMENDATIONS</p>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{bspAnalysisData.bsp_analysis.draft_update.data.safety_recommendations}</p>
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Trigger Alignment */}
                        {bspAnalysisData.bsp_analysis.trigger_alignment?.data && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e5e7eb',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspTriggerAlignment')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-people" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  Trigger Alignment
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge badge-info" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600' }}>
                                  {bspAnalysisData.bsp_analysis.trigger_alignment.data.confidence_level || 'N/A'} Confidence
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspTriggerAlignment ? 'ki-down' : 'ki-up'}`}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspTriggerAlignment && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  {bspAnalysisData.bsp_analysis.trigger_alignment.data.alignment_explanation && (
                                    <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{bspAnalysisData.bsp_analysis.trigger_alignment.data.alignment_explanation}</p>
                                    </div>
                                  )}
                                  {bspAnalysisData.bsp_analysis.trigger_alignment.data.matched_triggers?.length > 0 && (
                                    <div>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Matched Triggers</p>
                                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                        {(bspAnalysisData.bsp_analysis.trigger_alignment.data.matched_triggers || []).map((trigger: string, idx: number) => (
                                          <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', border: '1px solid #e9d5ff' }}>
                                            <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{trigger}</p>
                                          </div>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Strategy Assessment */}
                        {bspAnalysisData.bsp_analysis.strategy_assessment?.data && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspStrategyAssessment')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-graph-up" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.strategy_assessment.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600', backgroundColor: '#6b46c1', color: 'white' }}>
                                  Action Required
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspStrategyAssessment ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspStrategyAssessment && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  {bspAnalysisData.bsp_analysis.strategy_assessment.data.staff_response_evaluation && (
                                    <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Staff Response Evaluation</p>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{bspAnalysisData.bsp_analysis.strategy_assessment.data.staff_response_evaluation}</p>
                                    </div>
                                  )}
                                  {bspAnalysisData.bsp_analysis.strategy_assessment.data.missing_proactive_strategies?.length > 0 && (
                                    <div>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Missing Proactive Strategies</p>
                                      {(bspAnalysisData.bsp_analysis.strategy_assessment.data.missing_proactive_strategies || []).map((strategy: string, idx: number) => (
                                        <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', marginBottom: '8px', border: '1px solid #e9d5ff' }}>
                                          <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{strategy}</p>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                  {bspAnalysisData.bsp_analysis.strategy_assessment.data.missed_reactive_strategies?.length > 0 && (
                                    <div>
                                      <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '8px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Missed Reactive Strategies</p>
                                      {(bspAnalysisData.bsp_analysis.strategy_assessment.data.missed_reactive_strategies || []).map((strategy: string, idx: number) => (
                                        <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', marginBottom: '8px', border: '1px solid #e9d5ff' }}>
                                          <p style={{ fontSize: '0.875rem', color: '#1f2937', lineHeight: '1.5' }}>{strategy}</p>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Identified Gaps Summary */}
                        {bspAnalysisData.bsp_analysis?.gaps_summary?.count > 0 && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspGapsSummary')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-category" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.gaps_summary.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600', backgroundColor: '#6b46c1', color: 'white' }}>
                                  {bspAnalysisData.bsp_analysis.gaps_summary.count} Issues
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspGapsSummary ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspGapsSummary && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {(bspAnalysisData.bsp_analysis.gaps_summary.data || []).map((gap: any, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937' }}>{typeof gap === 'string' ? gap : gap.description || gap.gap || JSON.stringify(gap)}</p>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* BSP Internal Inconsistencies */}
                        {bspAnalysisData.bsp_analysis?.inconsistencies?.count > 0 && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspInconsistencies')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-file" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.inconsistencies.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600', backgroundColor: '#6b46c1', color: 'white' }}>
                                  {bspAnalysisData.bsp_analysis.inconsistencies.count} Found
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspInconsistencies ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspInconsistencies && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                                  {(bspAnalysisData.bsp_analysis.inconsistencies.data || []).map((inconsistency: any, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937' }}>{typeof inconsistency === 'string' ? inconsistency : inconsistency.description || inconsistency.inconsistency || JSON.stringify(inconsistency)}</p>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Potentially Outdated Strategies */}
                        {bspAnalysisData.bsp_analysis?.outdated_strategies?.count > 0 && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspOutdatedStrategies')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-technology-2" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.outdated_strategies.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600', backgroundColor: '#6b46c1', color: 'white' }}>
                                  {bspAnalysisData.bsp_analysis.outdated_strategies.count} Strategies
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspOutdatedStrategies ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspOutdatedStrategies && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  {(bspAnalysisData.bsp_analysis.outdated_strategies.data || []).map((item: any, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      <p style={{ fontSize: '0.875rem', fontWeight: '600', color: '#1f2937', marginBottom: '8px' }}>{item.strategy || item}</p>
                                      {item.reason && (
                                        <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '4px' }}><strong>Reason:</strong> {item.reason}</p>
                                      )}
                                      {item.suggested_update && (
                                        <p style={{ fontSize: '0.75rem', color: '#6b7280' }}><strong>Suggested Update:</strong> {item.suggested_update}</p>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Skill Building Opportunities */}
                        {bspAnalysisData.bsp_analysis?.skill_building?.count > 0 && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspSkillBuilding')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-compass" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.skill_building.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className="badge" style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600', backgroundColor: '#6b46c1', color: 'white' }}>
                                  {bspAnalysisData.bsp_analysis.skill_building.count} Items
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspSkillBuilding ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspSkillBuilding && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                  {(bspAnalysisData.bsp_analysis.skill_building.data || []).map((item: any, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                      {item.skill_area && (
                                        <span className="badge badge-sm badge-light" style={{ fontSize: '0.75rem', padding: '4px 8px', marginBottom: '8px', display: 'inline-block' }}>
                                          {item.skill_area}
                                        </span>
                                      )}
                                      {item.recommendation && (
                                        <p style={{ fontSize: '0.875rem', color: '#1f2937', marginBottom: '8px' }}><strong>Recommendation:</strong> {item.recommendation}</p>
                                      )}
                                      {item.functional_basis && (
                                        <p style={{ fontSize: '0.75rem', color: '#6b7280' }}><strong>Functional Basis:</strong> {item.functional_basis}</p>
                                      )}
                                      {!item.recommendation && !item.functional_basis && (
                                        <p style={{ fontSize: '0.875rem', color: '#1f2937' }}>{item}</p>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Risk Insights */}
                        {bspAnalysisData.bsp_analysis.risk_insights?.data && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspRiskInsights')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-shield-tick" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.risk_insights.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className={`badge ${
                                  bspAnalysisData.bsp_analysis.risk_insights.data.recurrence_risk === 'high' ? 'badge-danger' :
                                  bspAnalysisData.bsp_analysis.risk_insights.data.recurrence_risk === 'medium' ? 'badge-warning' : 'badge-success'
                                }`} style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600' }}>
                                  {bspAnalysisData.bsp_analysis.risk_insights.data.recurrence_risk || 'N/A'} Risk
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspRiskInsights ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspRiskInsights && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                              {bspAnalysisData.bsp_analysis.risk_insights.data.risk_mitigation_summary && (
                                <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px' }}>Risk Mitigation Summary</p>
                                  <p style={{ fontSize: '0.875rem', color: '#1f2937' }}>{bspAnalysisData.bsp_analysis.risk_insights.data.risk_mitigation_summary}</p>
                                </div>
                              )}
                              {bspAnalysisData.bsp_analysis.risk_insights.data.environmental_risk_factors?.length > 0 && (
                                <div>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '8px' }}>Environmental Risk Factors</p>
                                  {(bspAnalysisData.bsp_analysis.risk_insights.data.environmental_risk_factors || []).map((factor: string, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', border: '1px solid #e9d5ff', marginBottom: '8px' }}>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937' }}>{factor}</p>
                                    </div>
                                  ))}
                                </div>
                              )}
                              {bspAnalysisData.bsp_analysis.risk_insights.data.behavioural_risk_factors?.length > 0 && (
                                <div>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '8px' }}>Behavioural Risk Factors</p>
                                  {(bspAnalysisData.bsp_analysis.risk_insights.data.behavioural_risk_factors || []).map((factor: string, idx: number) => (
                                    <div key={idx} style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', borderLeft: '3px solid #6b46c1', border: '1px solid #e9d5ff', marginBottom: '8px' }}>
                                      <p style={{ fontSize: '0.875rem', color: '#1f2937' }}>{factor}</p>
                                    </div>
                                  ))}
                                </div>
                              )}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* NDIS Compliance Assessment */}
                        {bspAnalysisData.bsp_analysis.compliance?.data && (
                          <div style={{
                            backgroundColor: 'white',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            overflow: 'hidden',
                            marginBottom: '8px'
                          }}>
                            <div
                              onClick={() => toggleSection('bspCompliance')}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'space-between',
                                padding: '14px 16px',
                                cursor: 'pointer',
                                backgroundColor: '#f5f3ff',
                                transition: 'background-color 0.2s'
                              }}
                            >
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <i className="ki-outline ki-shield-search" style={{ fontSize: '18px', color: '#6b46c1' }}></i>
                                <h5 style={{ fontSize: '0.875rem', fontWeight: '600', color: '#374151', margin: 0 }}>
                                  {bspAnalysisData.bsp_analysis.compliance.title}
                                </h5>
                              </div>
                              <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                <span className={`badge ${
                                  bspAnalysisData.bsp_analysis.compliance.data.compliance_level === 'compliant' ? 'badge-success' :
                                  bspAnalysisData.bsp_analysis.compliance.data.compliance_level === 'partial' ? 'badge-warning' : 'badge-danger'
                                }`} style={{ fontSize: '0.6875rem', padding: '4px 10px', fontWeight: '600' }}>
                                  {bspAnalysisData.bsp_analysis.compliance.data.compliance_level || 'N/A'}
                                </span>
                                <i className={`ki-outline ${collapsedSections.bspCompliance ? 'ki-down' : 'ki-up'}`} style={{ color: '#6b46c1' }}></i>
                              </div>
                            </div>
                            {!collapsedSections.bspCompliance && (
                              <div style={{ padding: '16px', backgroundColor: '#f5f3ff' }}>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>
                              {bspAnalysisData.bsp_analysis.compliance.data.person_centred_practice && (
                                <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px' }}>Person-Centred Practice</p>
                                  <div className="flex items-center justify-between">
                                    <span className={`badge ${bspAnalysisData.bsp_analysis.compliance.data.person_centred_practice.status === 'compliant' ? 'badge-success' : 'badge-danger'}`} style={{ fontSize: '0.75rem', padding: '4px 8px' }}>
                                      {bspAnalysisData.bsp_analysis.compliance.data.person_centred_practice.status}
                                    </span>
                                  </div>
                                  {bspAnalysisData.bsp_analysis.compliance.data.person_centred_practice.notes && (
                                    <p style={{ fontSize: '0.75rem', color: '#1f2937', marginTop: '8px' }}>{bspAnalysisData.bsp_analysis.compliance.data.person_centred_practice.notes}</p>
                                  )}
                                </div>
                              )}
                              {bspAnalysisData.bsp_analysis.compliance.data.positive_behaviour_support_framework && (
                                <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px' }}>PBS Framework</p>
                                  <div className="flex items-center justify-between">
                                    <span className={`badge ${bspAnalysisData.bsp_analysis.compliance.data.positive_behaviour_support_framework.status === 'compliant' ? 'badge-success' : 'badge-danger'}`} style={{ fontSize: '0.75rem', padding: '4px 8px' }}>
                                      {bspAnalysisData.bsp_analysis.compliance.data.positive_behaviour_support_framework.status}
                                    </span>
                                  </div>
                                  {bspAnalysisData.bsp_analysis.compliance.data.positive_behaviour_support_framework.notes && (
                                    <p style={{ fontSize: '0.75rem', color: '#1f2937', marginTop: '8px' }}>{bspAnalysisData.bsp_analysis.compliance.data.positive_behaviour_support_framework.notes}</p>
                                  )}
                                </div>
                              )}
                              {bspAnalysisData.bsp_analysis.compliance.data.restrictive_practice_documentation && (
                                <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px' }}>Restrictive Practice Documentation</p>
                                  <div className="flex items-center justify-between">
                                    <span className={`badge ${bspAnalysisData.bsp_analysis.compliance.data.restrictive_practice_documentation.status === 'compliant' ? 'badge-success' : 'badge-danger'}`} style={{ fontSize: '0.75rem', padding: '4px 8px' }}>
                                      {bspAnalysisData.bsp_analysis.compliance.data.restrictive_practice_documentation.status}
                                    </span>
                                  </div>
                                  {bspAnalysisData.bsp_analysis.compliance.data.restrictive_practice_documentation.notes && (
                                    <p style={{ fontSize: '0.75rem', color: '#1f2937', marginTop: '8px' }}>{bspAnalysisData.bsp_analysis.compliance.data.restrictive_practice_documentation.notes}</p>
                                  )}
                                </div>
                              )}
                              {bspAnalysisData.bsp_analysis.compliance.data.environment_safety_obligations && (
                                <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px' }}>Environment Safety</p>
                                  <div className="flex items-center justify-between">
                                    <span className={`badge ${bspAnalysisData.bsp_analysis.compliance.data.environment_safety_obligations.status === 'compliant' ? 'badge-success' : 'badge-danger'}`} style={{ fontSize: '0.75rem', padding: '4px 8px' }}>
                                      {bspAnalysisData.bsp_analysis.compliance.data.environment_safety_obligations.status}
                                    </span>
                                  </div>
                                  {bspAnalysisData.bsp_analysis.compliance.data.environment_safety_obligations.notes && (
                                    <p style={{ fontSize: '0.75rem', color: '#1f2937', marginTop: '8px' }}>{bspAnalysisData.bsp_analysis.compliance.data.environment_safety_obligations.notes}</p>
                                  )}
                                </div>
                              )}
                              {bspAnalysisData.bsp_analysis.compliance.data.incident_documentation_standards && (
                                <div style={{ backgroundColor: 'white', padding: '12px', borderRadius: '6px', border: '1px solid #e9d5ff' }}>
                                  <p style={{ fontSize: '0.75rem', fontWeight: '600', color: '#6b46c1', marginBottom: '6px' }}>Incident Documentation</p>
                                  <div className="flex items-center justify-between">
                                    <span className={`badge ${bspAnalysisData.bsp_analysis.compliance.data.incident_documentation_standards.status === 'compliant' ? 'badge-success' : 'badge-danger'}`} style={{ fontSize: '0.75rem', padding: '4px 8px' }}>
                                      {bspAnalysisData.bsp_analysis.compliance.data.incident_documentation_standards.status}
                                    </span>
                                  </div>
                                  {bspAnalysisData.bsp_analysis.compliance.data.incident_documentation_standards.notes && (
                                    <p style={{ fontSize: '0.75rem', color: '#1f2937', marginTop: '8px' }}>{bspAnalysisData.bsp_analysis.compliance.data.incident_documentation_standards.notes}</p>
                                  )}
                                </div>
                              )}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                        </div>
                      </div>
                    ) : (
                      <div style={{
                        backgroundColor: 'white',
                        borderLeft: '4px solid #6b46c1',
                        borderRadius: '8px',
                        padding: '24px',
                        marginBottom: '24px'
                      }}>
                        <div style={{
                          display: 'flex',
                          justifyContent: 'space-between',
                          alignItems: 'center',
                          marginBottom: '20px'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <i className="ki-outline ki-abstract-26" style={{ fontSize: '24px', color: '#6b46c1' }}></i>
                            <h4 style={{ fontSize: '1.125rem', fontWeight: '600', color: '#1f2937', margin: 0 }}>
                              AI-Powered BSP Analysis
                            </h4>
                          </div>
                          <button
                            type="button"
                            className="btn btn-primary btn-sm"
                            onClick={() => selectedIncidentDetails && handleRunBspAnalysis(selectedIncidentDetails.id)}
                          >
                            <i className="ki-outline ki-abstract-26 text-sm mr-1"></i>
                            Run BSP Analysis
                          </button>
                        </div>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          alignItems: 'center',
                          justifyContent: 'center',
                          padding: '60px 20px',
                          minHeight: '300px'
                        }}>
                          <i className="ki-outline ki-abstract-26" style={{
                            fontSize: '64px',
                            color: '#9333ea',
                            marginBottom: '20px'
                          }}></i>
                          <p style={{
                            fontSize: '1rem',
                            color: '#6b46c1',
                            fontWeight: '500',
                            marginBottom: '8px',
                            textAlign: 'center'
                          }}>
                            Click "Run BSP Analysis" to analyse this incident
                          </p>
                          <p style={{
                            fontSize: '0.875rem',
                            color: '#9333ea',
                            textAlign: 'center'
                          }}>
                            Maps triggers, strategies, and risk factors against the participant's BSP
                          </p>
                        </div>
                      </div>
                    )}
                      </div>
                    )}

                    {/* INCIDENT DETAILS TAB */}
                    {activeModalTab === 'details' && (
                      <div style={{
                        animation: 'fadeIn 0.3s ease-in-out',
                        padding: '24px'
                      }}>
                    {/* Core Incident Information */}
                    <div style={{
                      backgroundColor: 'white',
                      borderRadius: '12px',
                      padding: '20px',
                      marginBottom: '16px',
                      border: '1px solid #e9d5ff'
                    }}>
                      <div style={{ marginBottom: '16px' }}>
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          justifyContent: 'space-between',
                          gap: '8px',
                          marginBottom: '4px',
                          backgroundColor: '#f5f3ff',
                          padding: '8px 12px',
                          borderRadius: '6px',
                          borderLeft: '3px solid #6b46c1'
                        }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <i className="ki-outline ki-information-2" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                            <h4 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                              Core Incident Information
                            </h4>
                          </div>
                          <span className={`badge ${getStatusBadgeClass(selectedIncidentDetails.status)}`} style={{ fontSize: '0.6875rem', padding: '4px 10px' }}>
                            {selectedIncidentDetails.status || 'Draft'}
                          </span>
                        </div>
                      </div>

                      {/* Two Column Layout */}
                      <div className="grid md:grid-cols-2 gap-3" style={{ marginBottom: '14px' }}>
                        {/* Incident Profile */}
                        <div style={{
                          backgroundColor: '#f5f3ff',
                          borderRadius: '8px',
                          padding: '14px',
                          border: '1px solid #e9d5ff'
                        }}>
                          <h5 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                            Incident Profile
                          </h5>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                              <i className="ki-outline ki-calendar" style={{ fontSize: '14px', color: '#6b46c1', marginTop: '2px' }}></i>
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Date & Time</p>
                                <p style={{ fontSize: '0.8125rem', color: '#111827', fontWeight: '500', margin: 0 }}>
                                  {formatDateTime(selectedIncidentDetails.incident_date_time).date}
                                </p>
                                <p style={{ fontSize: '0.75rem', color: '#6b7280', margin: 0 }}>
                                  {formatDateTime(selectedIncidentDetails.incident_date_time).time}
                                </p>
                              </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                              <i className="ki-outline ki-geolocation" style={{ fontSize: '14px', color: '#6b46c1', marginTop: '2px' }}></i>
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Location</p>
                                <p style={{ fontSize: '0.8125rem', color: '#111827', fontWeight: '500', margin: 0 }}>
                                  {selectedIncidentDetails.location || 'N/A'}
                                </p>
                              </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                              <i className="ki-outline ki-category" style={{ fontSize: '14px', color: '#6b46c1', marginTop: '2px' }}></i>
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Incident Type</p>
                                <p style={{ fontSize: '0.8125rem', color: '#111827', fontWeight: '500', margin: 0 }}>
                                  {typeof selectedIncidentDetails.incident_type === 'object' && selectedIncidentDetails.incident_type?.name
                                    ? selectedIncidentDetails.incident_type.name
                                    : selectedIncidentDetails.incident_type || 'N/A'}
                                </p>
                              </div>
                            </div>
                            <div style={{ display: 'flex', alignItems: 'flex-start', gap: '8px' }}>
                              <i className="ki-outline ki-shield-tick" style={{ fontSize: '14px', color: '#6b46c1', marginTop: '2px' }}></i>
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Severity</p>
                                <span className={`badge ${getSeverityBadgeClass(selectedIncidentDetails.severity)}`} style={{ fontSize: '0.75rem', padding: '3px 10px' }}>
                                  {selectedIncidentDetails.severity}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Basic Info & Classification */}
                        <div style={{
                          backgroundColor: '#f5f3ff',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          padding: '14px'
                        }}>
                          <h5 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                            Basic Info & Classification
                          </h5>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', overflow: 'hidden' }}>
                            <div>
                              <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Status</p>
                              <span className={`badge ${getStatusBadgeClass(selectedIncidentDetails.status)}`} style={{ fontSize: '0.75rem', padding: '3px 10px' }}>
                                {selectedIncidentDetails.status || 'Draft'}
                              </span>
                            </div>
                            <div>
                              <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Participant</p>
                              <p style={{ fontSize: '0.8125rem', color: '#111827', fontWeight: '500', margin: 0 }}>
                                {selectedIncidentDetails.participant_name || 'N/A'}
                              </p>
                            </div>
                            {selectedIncidentDetails.key_contributing_factors && selectedIncidentDetails.key_contributing_factors.length > 0 && (
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Key Contributing Factors</p>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '6px' }}>
                                  {selectedIncidentDetails.key_contributing_factors.map((factor: string, idx: number) => (
                                    <span
                                      key={idx}
                                      style={{
                                        backgroundColor: '#ddd6fe',
                                        color: '#5b21b6',
                                        padding: '6px 12px',
                                        borderRadius: '12px',
                                        fontSize: '0.75rem',
                                        fontWeight: '500',
                                        display: 'inline-block',
                                        width: 'fit-content'
                                      }}
                                    >
                                      {factor}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>

                      {/* Draft Summary */}
                      {selectedIncidentDetails.description && (
                        <div style={{
                          backgroundColor: 'white',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          padding: '14px',
                          marginTop: '14px'
                        }}>
                          <h5 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', marginBottom: '10px', textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                            Draft Summary
                          </h5>
                          <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                            {selectedIncidentDetails.description}
                          </p>
                        </div>
                      )}
                    </div>

                    {/* People Involved - Removed as it's now in Core Incident Information */}
                    {selectedIncidentDetails.customer && (
                      <div style={{
                        backgroundColor: 'white',
                        borderRadius: '8px',
                        padding: '14px',
                        marginBottom: '12px',
                        border: '1px solid #e5e7eb'
                      }}>
                        <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '4px', textTransform: 'uppercase', letterSpacing: '0.5px', fontWeight: '600' }}>Customer</p>
                        <p style={{ fontSize: '0.875rem', color: '#111827', fontWeight: '500', margin: 0 }}>
                          {selectedIncidentDetails.customer.first_name} {selectedIncidentDetails.customer.last_name}
                        </p>
                      </div>
                    )}

                    {/* NDIS Narrative Details - Collapsible Sections */}
                    <div style={{ marginBottom: '16px' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px', paddingLeft: '4px' }}>
                        <i className="ki-outline ki-document" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                        <h3 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                          NDIS Narrative Details
                        </h3>
                      </div>

                      {/* What Happened */}
                      {selectedIncidentDetails.what_happened && (
                        <div style={{
                          backgroundColor: 'white',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          marginBottom: '8px',
                          overflow: 'hidden'
                        }}>
                          <div
                            onClick={() => toggleSection('whatHappened')}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '12px 16px',
                              cursor: 'pointer',
                              backgroundColor: '#f5f3ff',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ede9fe'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f5f3ff'}
                          >
                            <h4 style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#6b46c1', margin: 0 }}>
                              What Happened
                            </h4>
                            <i
                              className={`ki-outline ${collapsedSections.whatHappened ? 'ki-down' : 'ki-up'}`}
                              style={{ fontSize: '0.75rem', color: '#6b46c1' }}
                            ></i>
                          </div>
                          {!collapsedSections.whatHappened && (
                            <div style={{ padding: '14px 16px', backgroundColor: '#f5f3ff', borderTop: '1px solid #e9d5ff' }}>
                              <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                                {selectedIncidentDetails.what_happened}
                              </p>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Lead-Up & Triggers */}
                      {selectedIncidentDetails.lead_up_triggers && (
                        <div style={{
                          backgroundColor: 'white',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          marginBottom: '8px',
                          overflow: 'hidden'
                        }}>
                          <div
                            onClick={() => toggleSection('leadUpTriggers')}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '12px 16px',
                              cursor: 'pointer',
                              backgroundColor: '#f5f3ff',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ede9fe'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f5f3ff'}
                          >
                            <h4 style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#6b46c1', margin: 0 }}>
                              Lead Up & Triggers
                            </h4>
                            <i
                              className={`ki-outline ${collapsedSections.leadUpTriggers ? 'ki-down' : 'ki-up'}`}
                              style={{ fontSize: '0.75rem', color: '#6b46c1' }}
                            ></i>
                          </div>
                          {!collapsedSections.leadUpTriggers && (
                            <div style={{ padding: '14px 16px', backgroundColor: '#f5f3ff', borderTop: '1px solid #e9d5ff' }}>
                              <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                                {selectedIncidentDetails.lead_up_triggers}
                              </p>
                            </div>
                          )}
                        </div>
                      )}

                      {/* During Incident */}
                      {selectedIncidentDetails.during_incident && (
                        <div style={{
                          backgroundColor: 'white',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          marginBottom: '8px',
                          overflow: 'hidden'
                        }}>
                          <div
                            onClick={() => toggleSection('duringIncident')}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '12px 16px',
                              cursor: 'pointer',
                              backgroundColor: '#f5f3ff',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ede9fe'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f5f3ff'}
                          >
                            <h4 style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#6b46c1', margin: 0 }}>
                              During Incident
                            </h4>
                            <i
                              className={`ki-outline ${collapsedSections.duringIncident ? 'ki-down' : 'ki-up'}`}
                              style={{ fontSize: '0.75rem', color: '#6b46c1' }}
                            ></i>
                          </div>
                          {!collapsedSections.duringIncident && (
                            <div style={{ padding: '14px 16px', backgroundColor: '#f5f3ff', borderTop: '1px solid #e9d5ff' }}>
                              <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                                {selectedIncidentDetails.during_incident}
                              </p>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Response Actions */}
                      {selectedIncidentDetails.response_actions && (
                        <div style={{
                          backgroundColor: 'white',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          marginBottom: '8px',
                          overflow: 'hidden'
                        }}>
                          <div
                            onClick={() => toggleSection('responseActions')}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '12px 16px',
                              cursor: 'pointer',
                              backgroundColor: '#f5f3ff',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ede9fe'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f5f3ff'}
                          >
                            <h4 style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#6b46c1', margin: 0 }}>
                              Response Actions
                            </h4>
                            <i
                              className={`ki-outline ${collapsedSections.responseActions ? 'ki-down' : 'ki-up'}`}
                              style={{ fontSize: '0.75rem', color: '#6b46c1' }}
                            ></i>
                          </div>
                          {!collapsedSections.responseActions && (
                            <div style={{ padding: '14px 16px', backgroundColor: '#f5f3ff', borderTop: '1px solid #e9d5ff' }}>
                              <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                                {selectedIncidentDetails.response_actions}
                              </p>
                            </div>
                          )}
                        </div>
                      )}

                      {/* Causes & Contributing Factors */}
                      {selectedIncidentDetails.causes_contributing_factors && (
                        <div style={{
                          backgroundColor: 'white',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          marginBottom: '8px',
                          overflow: 'hidden'
                        }}>
                          <div
                            onClick={() => toggleSection('causesFactors')}
                            style={{
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'space-between',
                              padding: '12px 16px',
                              cursor: 'pointer',
                              backgroundColor: '#f5f3ff',
                              transition: 'background-color 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.backgroundColor = '#ede9fe'}
                            onMouseLeave={(e) => e.currentTarget.style.backgroundColor = '#f5f3ff'}
                          >
                            <h4 style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#6b46c1', margin: 0 }}>
                              Causes & Contributing Factors
                            </h4>
                            <i
                              className={`ki-outline ${collapsedSections.causesFactors ? 'ki-down' : 'ki-up'}`}
                              style={{ fontSize: '0.75rem', color: '#6b46c1' }}
                            ></i>
                          </div>
                          {!collapsedSections.causesFactors && (
                            <div style={{ padding: '14px 16px', backgroundColor: '#f5f3ff', borderTop: '1px solid #e9d5ff' }}>
                              <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                                {selectedIncidentDetails.causes_contributing_factors}
                              </p>
                            </div>
                          )}
                        </div>
                      )}
                    </div>

                    {/* Impact & Response Section */}
                    <div style={{
                      backgroundColor: 'white',
                      borderRadius: '12px',
                      padding: '20px',
                      marginBottom: '16px',
                      border: '1px solid #e9d5ff'
                    }}>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        marginBottom: '16px',
                        backgroundColor: '#f5f3ff',
                        padding: '8px 12px',
                        borderRadius: '6px',
                        borderLeft: '3px solid #6b46c1'
                      }}>
                        <i className="ki-outline ki-pulse" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                        <h4 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                          Impact & Response
                        </h4>
                      </div>

                      {/* Medical & Injury */}
                      <div style={{
                        backgroundColor: '#f5f3ff',
                        border: '1px solid #e9d5ff',
                        borderRadius: '8px',
                        padding: '14px',
                        marginBottom: '12px'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                          <i className="ki-outline ki-shield-cross" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                          <h5 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            Medical & Injury
                          </h5>
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <i className={`ki-outline ${selectedIncidentDetails.injury_occurred ? 'ki-cross' : 'ki-check'}`}
                               style={{ fontSize: '16px', color: selectedIncidentDetails.injury_occurred ? '#ef4444' : '#10b981' }}></i>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
                              <span style={{ fontSize: '0.8125rem', color: '#374151', fontWeight: '500' }}>Injury Occurred</span>
                              <span style={{ marginLeft: 'auto', fontSize: '0.75rem', color: '#6b7280' }}>
                                {selectedIncidentDetails.injury_occurred ? 'Yes' : 'No'}
                              </span>
                            </div>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <i className={`ki-outline ${selectedIncidentDetails.medical_treatment_required ? 'ki-cross' : 'ki-check'}`}
                               style={{ fontSize: '16px', color: selectedIncidentDetails.medical_treatment_required ? '#ef4444' : '#10b981' }}></i>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', flex: 1 }}>
                              <span style={{ fontSize: '0.8125rem', color: '#374151', fontWeight: '500' }}>Medical Treatment Required</span>
                              <span style={{ marginLeft: 'auto', fontSize: '0.75rem', color: '#6b7280' }}>
                                {selectedIncidentDetails.medical_treatment_required ? 'Yes' : 'No'}
                              </span>
                            </div>
                          </div>
                        </div>
                        {selectedIncidentDetails.injury_details && (
                          <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #e9d5ff' }}>
                            <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '6px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Injury Details</p>
                            <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.5', whiteSpace: 'pre-wrap', margin: 0 }}>
                              {selectedIncidentDetails.injury_details}
                            </p>
                          </div>
                        )}
                      </div>

                      {/* Reporting */}
                      <div style={{
                        backgroundColor: '#f5f3ff',
                        border: '1px solid #e9d5ff',
                        borderRadius: '8px',
                        padding: '14px',
                        marginBottom: '12px'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' }}>
                          <i className="ki-outline ki-notification-status" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                          <h5 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            Reporting
                          </h5>
                        </div>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                            <span style={{ fontSize: '0.8125rem', color: '#374151', fontWeight: '500' }}>NDIS Reportable</span>
                            <span className={`badge ${selectedIncidentDetails.is_ndis_reportable ? 'badge-success' : 'badge-light'}`} style={{ fontSize: '0.75rem', padding: '4px 10px' }}>
                              {selectedIncidentDetails.is_ndis_reportable ? 'Yes' : 'No'}
                            </span>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                            <span style={{ fontSize: '0.8125rem', color: '#374151', fontWeight: '500' }}>Police Notified</span>
                            <span className={`badge ${selectedIncidentDetails.police_notified ? 'badge-info' : 'badge-light'}`} style={{ fontSize: '0.75rem', padding: '4px 10px' }}>
                              {selectedIncidentDetails.police_notified ? 'Yes' : 'No'}
                            </span>
                          </div>
                        </div>
                        {selectedIncidentDetails.notification_made_to && (
                          <div style={{ marginTop: '12px', paddingTop: '12px', borderTop: '1px solid #e9d5ff' }}>
                            <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '6px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Notification Made To</p>
                            <p style={{ fontSize: '0.8125rem', color: '#374151', margin: 0, lineHeight: '1.5' }}>
                              {selectedIncidentDetails.notification_made_to}
                              {selectedIncidentDetails.notification_date_time && (
                                <span style={{ fontSize: '0.75rem', color: '#6b7280', marginLeft: '8px' }}>
                                  ({formatDateTime(selectedIncidentDetails.notification_date_time).date})
                                </span>
                              )}
                            </p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* System Analysis (BSP Notes) */}
                    {(selectedIncidentDetails.bsp_alignment_notes || selectedIncidentDetails.bsp_suggested_improvements) && (
                      <div style={{
                        backgroundColor: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        marginBottom: '16px',
                        border: '1px solid #e9d5ff'
                      }}>
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                          marginBottom: '16px',
                          backgroundColor: '#f5f3ff',
                          padding: '8px 12px',
                          borderRadius: '6px',
                          borderLeft: '3px solid #6b46c1'
                        }}>
                          <i className="ki-outline ki-abstract-26" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                          <h4 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                            System Analysis
                          </h4>
                        </div>

                        {selectedIncidentDetails.bsp_alignment_notes && (
                          <div style={{
                            backgroundColor: '#f5f3ff',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            padding: '14px',
                            marginBottom: '12px',
                            borderLeft: '3px solid #6b46c1'
                          }}>
                            <p style={{ fontSize: '0.75rem', color: '#6b46c1', marginBottom: '6px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>BSP Alignment Notes</p>
                            <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                              {selectedIncidentDetails.bsp_alignment_notes}
                            </p>
                          </div>
                        )}

                        {selectedIncidentDetails.bsp_suggested_improvements && (
                          <div style={{
                            backgroundColor: '#f5f3ff',
                            border: '1px solid #e9d5ff',
                            borderRadius: '8px',
                            padding: '14px',
                            borderLeft: '3px solid #6b46c1'
                          }}>
                            <p style={{ fontSize: '0.75rem', color: '#6b46c1', marginBottom: '6px', fontWeight: '700', textTransform: 'uppercase', letterSpacing: '0.5px' }}>Suggested Improvements</p>
                            <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.6', whiteSpace: 'pre-wrap', margin: 0 }}>
                              {selectedIncidentDetails.bsp_suggested_improvements}
                            </p>
                          </div>
                        )}
                      </div>
                    )}

                    {/* Follow-Up */}
                    {(selectedIncidentDetails.recurrence_likelihood || selectedIncidentDetails.follow_up_actions_required) && (
                      <div style={{
                        backgroundColor: 'white',
                        borderRadius: '12px',
                        padding: '20px',
                        marginBottom: '16px',
                        border: '1px solid #e9d5ff'
                      }}>
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                          marginBottom: '16px',
                          backgroundColor: '#f5f3ff',
                          padding: '8px 12px',
                          borderRadius: '6px',
                          borderLeft: '3px solid #6b46c1'
                        }}>
                          <i className="ki-outline ki-calendar-tick" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                          <h4 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                            Follow-Up
                          </h4>
                        </div>

                        <div style={{
                          backgroundColor: '#f5f3ff',
                          border: '1px solid #e9d5ff',
                          borderRadius: '8px',
                          padding: '14px',
                          borderLeft: '3px solid #6b46c1'
                        }}>
                          <div className="grid md:grid-cols-2 gap-3">
                            {selectedIncidentDetails.recurrence_likelihood && (
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Recurrence Risk</p>
                                <p style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#111827', margin: 0 }}>
                                  {selectedIncidentDetails.recurrence_likelihood}
                                </p>
                              </div>
                            )}
                            {selectedIncidentDetails.follow_up_actions_required !== undefined && (
                              <div>
                                <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Action Required</p>
                                <p style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#111827', margin: 0 }}>
                                  {selectedIncidentDetails.follow_up_actions_required ? 'Yes' : 'No'}
                                </p>
                              </div>
                            )}
                          </div>
                          {selectedIncidentDetails.follow_up_notes && (
                            <div style={{ marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #e9d5ff' }}>
                              <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '4px', fontWeight: '600' }}>Notes:</p>
                              <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.5', whiteSpace: 'pre-wrap', margin: 0 }}>
                                {selectedIncidentDetails.follow_up_notes}
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    )}

                    {/* Risk Assessment & Follow-up */}
                    <div style={{
                      backgroundColor: 'white',
                      borderRadius: '12px',
                      padding: '20px',
                      marginBottom: '16px',
                      border: '1px solid #e9d5ff'
                    }}>
                      <div style={{
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        marginBottom: '16px',
                        backgroundColor: '#f5f3ff',
                        padding: '8px 12px',
                        borderRadius: '6px',
                        borderLeft: '3px solid #6b46c1'
                      }}>
                        <i className="ki-outline ki-security-user" style={{ fontSize: '16px', color: '#6b46c1' }}></i>
                        <h4 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.8px' }}>
                          Risk Assessment & Follow-up
                        </h4>
                      </div>

                      <div style={{
                        backgroundColor: '#f5f3ff',
                        border: '1px solid #e9d5ff',
                        borderRadius: '8px',
                        padding: '14px',
                        borderLeft: '3px solid #6b46c1'
                      }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' }}>
                          <i className="ki-outline ki-triangle" style={{ fontSize: '14px', color: '#6b46c1' }}></i>
                          <h5 style={{ fontSize: '0.75rem', fontWeight: '700', color: '#6b46c1', margin: 0, textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                            Risk Assessment
                          </h5>
                        </div>
                        <div className="grid md:grid-cols-2 gap-3">
                          <div>
                            <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '3px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Recurrence Likelihood</p>
                            <span style={{
                              display: 'inline-block',
                              fontSize: '0.75rem',
                              fontWeight: '600',
                              padding: '4px 10px',
                              borderRadius: '6px',
                              backgroundColor: selectedIncidentDetails.recurrence_likelihood === 'High' ? '#fee2e2' :
                                            selectedIncidentDetails.recurrence_likelihood === 'Medium' ? '#fef3c7' : '#dcfce7',
                              color: selectedIncidentDetails.recurrence_likelihood === 'High' ? '#dc2626' :
                                     selectedIncidentDetails.recurrence_likelihood === 'Medium' ? '#f59e0b' : '#10b981'
                            }}>
                              {selectedIncidentDetails.recurrence_likelihood || 'Not Assessed'}
                            </span>
                          </div>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{
                              width: '28px',
                              height: '28px',
                              borderRadius: '6px',
                              backgroundColor: selectedIncidentDetails.follow_up_required ? '#ddd6fe' : '#d1fae5',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center'
                            }}>
                              <i className={`ki-outline ${selectedIncidentDetails.follow_up_required ? 'ki-check' : 'ki-cross'}`}
                                 style={{ fontSize: '14px', color: selectedIncidentDetails.follow_up_required ? '#6b46c1' : '#10b981' }}></i>
                            </div>
                            <div>
                              <p style={{ fontSize: '0.6875rem', color: '#6b7280', marginBottom: '2px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.3px' }}>Follow-up Required</p>
                              <p style={{ fontSize: '0.8125rem', fontWeight: '600', color: '#111827', margin: 0 }}>
                                {selectedIncidentDetails.follow_up_required ? 'Yes' : 'No'}
                              </p>
                            </div>
                          </div>
                        </div>
                        {selectedIncidentDetails.follow_up_actions && selectedIncidentDetails.follow_up_required && (
                          <div style={{ marginTop: '10px', paddingTop: '10px', borderTop: '1px solid #e9d5ff' }}>
                            <p style={{ fontSize: '0.75rem', color: '#6b7280', marginBottom: '4px', fontWeight: '600' }}>Follow-up Actions:</p>
                            <p style={{ fontSize: '0.8125rem', color: '#374151', lineHeight: '1.5', whiteSpace: 'pre-wrap', margin: 0 }}>
                              {selectedIncidentDetails.follow_up_actions}
                            </p>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Reporter Signature */}
                    {selectedIncidentDetails.reporter_signature && (
                      <div className="card bg-primary-light/10 border-2 border-primary">
                        <div className="card-body">
                          <h4 className="text-lg font-bold text-gray-900 mb-4 flex items-center">
                            <i className="ki-outline ki-pencil text-xl mr-2 text-primary"></i>
                            Reporter Signature
                          </h4>
                          <div className="bg-white p-6 rounded-lg">
                            <div className="mb-4">
                              <p className="text-sm text-gray-600 mb-1">Signed by:</p>
                              <p className="text-base font-semibold text-gray-900">
                                {selectedIncidentDetails.reporting_user?.first_name} {selectedIncidentDetails.reporting_user?.last_name}
                              </p>
                            </div>
                            {selectedIncidentDetails.reporter_signed_at && (
                              <div className="mb-4">
                                <p className="text-sm text-gray-600 mb-1">Signed at:</p>
                                <p className="text-base text-gray-900">
                                  {new Date(selectedIncidentDetails.reporter_signed_at).toLocaleString('en-US', {
                                    dateStyle: 'full',
                                    timeStyle: 'short'
                                  })}
                                </p>
                              </div>
                            )}
                            <div className="mt-4">
                              <p className="text-sm text-gray-600 mb-2">Signature:</p>
                              <img
                                src={selectedIncidentDetails.reporter_signature}
                                alt="Reporter Signature"
                                className="border-2 border-primary rounded-lg max-w-md"
                                style={{ maxHeight: '200px' }}
                              />
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                      </div>
                    )}
                  </div>
                ) : (
                  <div className="text-center py-10">
                    <p className="text-gray-600">No incident details available.</p>
                  </div>
                )}
              </div>

              {/* Modal Footer - Only show on Incident Details tab */}
              {activeModalTab === 'details' && (
                <div className="modal-footer" style={{ padding: '16px 24px', borderTop: '1px solid #e5e7eb', display: 'flex', justifyContent: 'flex-end' }}>
                  <button
                    type="button"
                    className="btn btn-light"
                    onClick={closeReportModal}
                    style={{ cursor: 'pointer' }}
                  >
                    Close
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export { IncidentsTable };
